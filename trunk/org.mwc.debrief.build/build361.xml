<project default="deploy">
	<property file="build361.properties" />

	<!-- get it built in the correct place -->
	<property name="buildDirectory" value="${basedir}/buildDirectory" />

	<!-- and deploy it to the right place -->
	<property name="deployDest" value="../deploy" />
	<property name="debriefDest" value="${deployDest}/${archivePrefix}" />
	<property name="repoDest" value="${deployDest}/Repository" />
	<property name="osxExe" value="${deployDest}/DebriefNG/DebriefNG.app/Contents/MacOS/DebriefNG" />

	<target name="clean">
		<!-- note, the build fails if there's compiled code in the build directory -->
		<delete dir="${basedir}/buildDirectory" />
		<delete dir="${debriefDest}" />
		<delete dir="${repoDest}" />
	</target>

	<target name="build" depends="clean">

		<property name="builder" value="../deploy/${archivePrefix}" />

		<property name="baseLocation" value="${eclipse.home}" />

		<!-- by default, check for deltapack co-located with eclipse -->
		<available property="haveDeltaPack" file="${eclipse.home}/deltapack" />
		<fail unless="haveDeltaPack" message="The deltapack is required to build this product.  Please edit buildProduct.xml or set the &quot;deltapack&quot;" />

		<property name="pluginPath" value="${basedir}/..${path.separator}${deltapack}" />
		<property name="buildTempFolder" value="${buildDirectory}/tmp" />

		<ant antfile="${eclipse.pdebuild.scripts}/productBuild/productBuild.xml" />

	</target>

	<target name="deploy" depends="build" description="move compiled bits to deploy folder">

		<echo message="about to move the zips..."/>

		<copy todir="${debriefDest}">
			<fileset dir="${buildDirectory}/out/DebriefNG-win32.win32.x86.zip" />
		</copy>
		
		<copy todir="${repoDest}">
			<fileset dir="${buildDirectory}/buildRepo" />
		</copy>

		<!-- if we're on osx, sort out the file permissions -->
		<antcall target="sortOutExePermissions"></antcall>
		
		<!-- refresh the workspace -->
		<eclipse.convertPath fileSystemPath="${basedir}" property="resourcePath" />
		<eclipse.refreshLocal resource="${resourcePath}" depth="infinite" />

		<eclipse.convertPath fileSystemPath="${deployDest}" property="deployPath" />
		<eclipse.refreshLocal resource="${deployPath}" depth="infinite" />
	</target>
	
	<target name="isOSX">
	    <available file="${osxExe}" property="osx.Present"/>
	</target>
	
	<target name="sortOutExePermissions" depends="isOSX" if="osx.Present">
		<echo message="this is osx - setting exe permission" ></echo>
		<chmod file="${osxExe}" perm="ugo+x"/>
	</target>
</project>
